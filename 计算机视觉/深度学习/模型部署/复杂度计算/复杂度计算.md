### FLOPS和FLOPs

|       |                                  |                       |                                      |
| ----- | -------------------------------- | --------------------- | ------------------------------------ |
| FLOPS | 每秒浮点运算次数，理解为计算速度 | 衡量硬件性能的指标    | floating point operations per second |
| FLOPs | 浮点运算数，理解为计算量         | 衡量算法/模型的复杂度 | floating point operations            |

----



### 普通卷积复杂度
#### 时间复杂度（FLOPs）



单层：
$$
Time \sim O(M^2\times K^2 \times C_{in}\times C_{out})
$$

- $M$每个卷积核输出特征图（feature map）的边长。
- $K$每个卷积核（Kernel）的边长。
- $C_{in}$ 每个卷积核的通道数，也即输入通道数，也即上一层的输出通道数。
- $C_{out}$本卷积层具有的卷积核个数，也即输出通道数。



整个网络：
$$
Time \sim O(\sum^D_{l=1}M_{l}^{2} \cdot K_{l}^{2} \cdot C_{l-1} \cdot C_{l})
$$


- $D$神经网络所具有的卷积层数，也即网络的深度。
- $l$神经网络第$l$个卷积层。
- $C_l$神经网络第$l$个卷积层的输出通道数$C_{out}$，也即该层的卷积核个数。
- 对于第$l$个卷积层而言，其输入通道数$C_{in}$就是第$(l-1)$个卷积层的输出通道数。
- 可见，CNN整体的时间复杂度并不神秘，只是所有卷积层的时间复杂度累加而已。
- 简而言之，层内连乘，层间累加。

> 整个网络的复杂度其实就是每层的复杂度乘以层数。



#### 空间复杂度
空间复杂度（访存量），==严格来讲包括两部分：总参数量 + 各层输出特征图==。

**参数量**：模型所有带参数的层的权重参数总量（即**模型体积**，下式第一个求和表达式）

**特征图**：模型在实时运行过程中每层所计算出的输出特征图大小（下式第二个求和表达式）
$$
Space  \sim O\left(\sum_{l=1}^{D} K_{l}^{2} \cdot C_{l-1} \cdot C_{l}+\sum_{l=1}^{D} M^{2} \cdot C_{l}\right)
$$

- 总参数量只与卷积核的尺寸$K$ 、通道数$C$、层数$D$相关，而**与输入数据的大小无关**。
- 输出特征图的空间占用比较容易，就是其空间尺寸$M^2$和通道数$C$的连乘。
- 注：实际上有些层（例如 ReLU）其实是可以通过原位运算完成的，此时就不用统计输出特征图这一项了。



> 当我们需要裁剪模型时，由于卷积核的空间尺寸通常已经很小（3x3），而网络的深度又与模型的表征能力紧密相关，不宜过多削减，因此**模型裁剪通常最先下手的地方就是通道数**。
>
> 关于空间复杂度，我觉得应该分开考虑，每层的参数量确实可以相加，代表一个模型所需要的的存储空间。而计算过程中产生的特征图，则不应该直接相加，因为如果不需要特征复用的情况下，前置的特征图是不需要保留的。所以像`densenet`这种需要频繁特征复用的模型，所需要的内存空间会很大，容易爆显存。另外，单个特征图太大，缓存没法一次性读取，做一次计算就需要频繁的读写操作，也是会影响实际计算速度的。


- [ ] 待整理[让深度学习更高效运行的两个视角 | Paper Reading第二季第一期 - 知乎](https://app.yinxiang.com/shard/s45/nl/27030704/a586a496-0dce-4b6e-931d-58f09334280f)

----



### 深度可分离卷积

对输入特征图的每一层单独做卷积，再将得到的结果concatenate，用1x1的卷积做通道维度上的融合。

#### 时间复杂度

`depthwise`+`pointwise`：
$$
Time \sim O(M^2 \cdot K^2\cdot1\cdot C_{in}+M^2\cdot 1^2\cdot C_{in}\cdot C_{out})
$$

#### 空间复杂度

参数量：
$$
Space \sim O((K^2+C_{out})\cdot C_{in})
$$




> 具体参看[mobilenetV1](../../轻量级网络/MobileNet_V1/MobileNet.md)

